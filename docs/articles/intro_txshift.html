<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Targeted Learning with Stochastic Treatment Regimes • txshift</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Targeted Learning with Stochastic Treatment Regimes">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">txshift</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.2.3</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/intro_txshift.html">Targeted Learning with Stochastic Treatment Regimes</a>
    </li>
    <li>
      <a href="../articles/ipcw_txshift.html">IPCW-TMLEs with Stochastic Treatment Regimes</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/nhejazi/txshift">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Targeted Learning with Stochastic Treatment Regimes</h1>
                        <h4 class="author">
<a href="https://nimahejazi.org">Nima Hejazi</a> and <a href="https://www.benkeserstatistics.com/">David Benkeser</a>
</h4>
            
            <h4 class="date">2019-03-31</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/nhejazi/txshift/blob/master/vignettes/intro_txshift.Rmd"><code>vignettes/intro_txshift.Rmd</code></a></small>
      <div class="hidden name"><code>intro_txshift.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level2">
<h2 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h2>
<p>Stochastic treatment regimes present a relatively simple manner in which to assess the effects of continuous treatments by way of parameters that examine the effects induced by the counterfactual shifting of the observed values of a treatment of interest. Here, we present an implementation of a new algorithm for computing targeted minimum loss-based estimates of treatment shift parameters defined based on a shifting function <span class="math inline">\(d(A,W)\)</span>. For a technical presentation of the algorithm, the interested reader is invited to consult <span class="citation">Díaz and van der Laan (2018)</span>. For additional background on Targeted Learning and previous work on stochastic treatment regimes, please consider consulting <span class="citation">van der Laan and Rose (2011)</span>, <span class="citation">van der Laan and Rose (2018)</span>, and <span class="citation">Díaz and van der Laan (2012)</span>.</p>
<p>To start, let’s load the packages we’ll use and set a seed for simulation:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(tidyverse)</a></code></pre></div>
<pre><code>## ── Attaching packages ────────────────────────────────── tidyverse 1.2.1 ──</code></pre>
<pre><code>## ✔ ggplot2 3.1.0       ✔ purrr   0.3.2  
## ✔ tibble  2.1.1       ✔ dplyr   0.8.0.1
## ✔ tidyr   0.8.3       ✔ stringr 1.4.0  
## ✔ readr   1.3.1       ✔ forcats 0.4.0</code></pre>
<pre><code>## ── Conflicts ───────────────────────────────────── tidyverse_conflicts() ──
## ✖ dplyr::filter() masks stats::filter()
## ✖ dplyr::lag()    masks stats::lag()</code></pre>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(data.table)</a></code></pre></div>
<pre><code>## 
## Attaching package: 'data.table'</code></pre>
<pre><code>## The following objects are masked from 'package:dplyr':
## 
##     between, first, last</code></pre>
<pre><code>## The following object is masked from 'package:purrr':
## 
##     transpose</code></pre>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(haldensify)</a></code></pre></div>
<pre><code>## haldensify v0.0.3: Conditional Density Estimation with the Highly Adaptive Lasso</code></pre>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(sl3)</a>
<a class="sourceLine" id="cb11-2" data-line-number="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(txshift)</a></code></pre></div>
<pre><code>## txshift v0.2.3: Targeted Learning of the Causal Effects of Stochastic Interventions</code></pre>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Random">set.seed</a></span>(<span class="dv">429153</span>)</a></code></pre></div>
<hr>
</div>
<div id="data-and-notation" class="section level2">
<h2 class="hasAnchor">
<a href="#data-and-notation" class="anchor"></a>Data and Notation</h2>
<ol style="list-style-type: decimal">
<li><p>Start with a simple additive shift – i.e., <span class="math inline">\(d(a,w) = a + \delta\)</span> if <span class="math inline">\(a &lt; u(w) - \delta\)</span> or <span class="math inline">\(d(a, w) = a\)</span> if <span class="math inline">\(a \geq u(w) - \delta\)</span>.</p></li>
<li><p>The additive shift will have support everywhere (i.e., <span class="math inline">\(a &lt; u(w)\)</span> is true everywhere).</p></li>
<li><p>The data structure that we now observe is <span class="math inline">\(O = (W, A, Y)\)</span>.</p></li>
</ol>
<div id="simulate-data" class="section level3">
<h3 class="hasAnchor">
<a href="#simulate-data" class="anchor"></a>Simulate Data</h3>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1"><span class="co"># simulate simple data for tmle-shift sketch</span></a>
<a class="sourceLine" id="cb14-2" data-line-number="2">n_obs &lt;-<span class="st"> </span><span class="dv">1000</span>  <span class="co"># number of observations</span></a>
<a class="sourceLine" id="cb14-3" data-line-number="3">n_w &lt;-<span class="st"> </span><span class="dv">1</span>  <span class="co"># number of baseline covariates</span></a>
<a class="sourceLine" id="cb14-4" data-line-number="4">tx_mult &lt;-<span class="st"> </span><span class="dv">2</span>  <span class="co"># multiplier for the effect of W = 1 on the treatment</span></a>
<a class="sourceLine" id="cb14-5" data-line-number="5"></a>
<a class="sourceLine" id="cb14-6" data-line-number="6">## baseline covariate -- simple, binary</a>
<a class="sourceLine" id="cb14-7" data-line-number="7">W &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/numeric">as.numeric</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/lapply">replicate</a></span>(n_w, <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Binomial">rbinom</a></span>(n_obs, <span class="dv">1</span>, <span class="fl">0.5</span>)))</a>
<a class="sourceLine" id="cb14-8" data-line-number="8"></a>
<a class="sourceLine" id="cb14-9" data-line-number="9">## create treatment based on baseline W</a>
<a class="sourceLine" id="cb14-10" data-line-number="10">A &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/numeric">as.numeric</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">rnorm</a></span>(n_obs, <span class="dt">mean =</span> tx_mult <span class="op">*</span><span class="st"> </span>W, <span class="dt">sd =</span> <span class="dv">1</span>))</a>
<a class="sourceLine" id="cb14-11" data-line-number="11"></a>
<a class="sourceLine" id="cb14-12" data-line-number="12"><span class="co"># create outcome as a linear function of A, W + white noise</span></a>
<a class="sourceLine" id="cb14-13" data-line-number="13">Y &lt;-<span class="st"> </span>A <span class="op">+</span><span class="st"> </span>W <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">rnorm</a></span>(n_obs, <span class="dt">mean =</span> <span class="dv">0</span>, <span class="dt">sd =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb14-14" data-line-number="14"></a>
<a class="sourceLine" id="cb14-15" data-line-number="15"><span class="co"># shift parameter</span></a>
<a class="sourceLine" id="cb14-16" data-line-number="16">delta &lt;-<span class="st"> </span><span class="fl">0.5</span></a></code></pre></div>
<hr>
</div>
</div>
<div id="methodology" class="section level2">
<h2 class="hasAnchor">
<a href="#methodology" class="anchor"></a>Methodology</h2>
<div id="estimating-stochastic-interventions-effects-with-generalized-linear-models" class="section level3">
<h3 class="hasAnchor">
<a href="#estimating-stochastic-interventions-effects-with-generalized-linear-models" class="anchor"></a>Estimating Stochastic Interventions Effects with Generalized Linear Models</h3>
<p>The simplest way to compute the TML estimator for the stochastic treatment regime is to fit each of the major constituent parts (nuisance parameters) of the estimator with generalized linear models. To do this, one may merely call the <code>tmle_shifttx</code> function, providing the standard inputs listed below.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" data-line-number="1">tmle_hal_shift_<span class="dv">1</span> &lt;-<span class="st"> </span><span class="kw"><a href="../reference/txshift.html">txshift</a></span>(<span class="dt">W =</span> W, <span class="dt">A =</span> A, <span class="dt">Y =</span> Y, <span class="dt">delta =</span> delta,</a>
<a class="sourceLine" id="cb15-2" data-line-number="2">                            <span class="dt">fluc_method =</span> <span class="st">"standard"</span>,</a>
<a class="sourceLine" id="cb15-3" data-line-number="3">                            <span class="dt">g_fit_args =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">fit_type =</span> <span class="st">"hal"</span>,</a>
<a class="sourceLine" id="cb15-4" data-line-number="4">                                              <span class="dt">n_bins =</span> <span class="dv">5</span>,</a>
<a class="sourceLine" id="cb15-5" data-line-number="5">                                              <span class="dt">grid_type =</span> <span class="st">"equal_mass"</span>,</a>
<a class="sourceLine" id="cb15-6" data-line-number="6">                                              <span class="dt">lambda_seq =</span></a>
<a class="sourceLine" id="cb15-7" data-line-number="7">                                                <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Log">exp</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/seq">seq</a></span>(<span class="op">-</span><span class="dv">1</span>, <span class="dv">-9</span>,</a>
<a class="sourceLine" id="cb15-8" data-line-number="8">                                                        <span class="dt">length =</span> <span class="dv">300</span>))),</a>
<a class="sourceLine" id="cb15-9" data-line-number="9">                            <span class="dt">Q_fit_args =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">fit_type =</span> <span class="st">"glm"</span>,</a>
<a class="sourceLine" id="cb15-10" data-line-number="10">                                              <span class="dt">glm_formula =</span> <span class="st">"Y ~ ."</span>)</a>
<a class="sourceLine" id="cb15-11" data-line-number="11">                           )</a>
<a class="sourceLine" id="cb15-12" data-line-number="12"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/summary">summary</a></span>(tmle_hal_shift_<span class="dv">1</span>)</a></code></pre></div>
<pre><code>##       lwr_ci    param_est       upr_ci    param_var     eif_mean 
##      1.91991      2.05285       2.1858       0.0046 -1.43960e-15 
##    estimator       n_iter 
##         tmle            0</code></pre>
<p>When computing any such TML estimator, we may, of course, vary the regressions used in fitting the nuisance parameters; however, an even simpler variation is to fit the step for the fluctuation submodels with a <em>weighted</em> method, simply weighting each observation by an auxiliary covariate (often denoted <span class="math inline">\(H_n\)</span>, and sometimes called the “clever covariate” in the literature) rather than using such a covariate directly in the submodel regression fit.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" data-line-number="1">tmle_hal_shift_<span class="dv">2</span> &lt;-<span class="st"> </span><span class="kw"><a href="../reference/txshift.html">txshift</a></span>(<span class="dt">W =</span> W, <span class="dt">A =</span> A, <span class="dt">Y =</span> Y, <span class="dt">delta =</span> delta,</a>
<a class="sourceLine" id="cb17-2" data-line-number="2">                            <span class="dt">fluc_method =</span> <span class="st">"weighted"</span>,</a>
<a class="sourceLine" id="cb17-3" data-line-number="3">                            <span class="dt">g_fit_args =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">fit_type =</span> <span class="st">"hal"</span>,</a>
<a class="sourceLine" id="cb17-4" data-line-number="4">                                              <span class="dt">n_bins =</span> <span class="dv">5</span>,</a>
<a class="sourceLine" id="cb17-5" data-line-number="5">                                              <span class="dt">grid_type =</span> <span class="st">"equal_mass"</span>,</a>
<a class="sourceLine" id="cb17-6" data-line-number="6">                                              <span class="dt">lambda_seq =</span></a>
<a class="sourceLine" id="cb17-7" data-line-number="7">                                                <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Log">exp</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/seq">seq</a></span>(<span class="op">-</span><span class="dv">1</span>, <span class="dv">-9</span>,</a>
<a class="sourceLine" id="cb17-8" data-line-number="8">                                                        <span class="dt">length =</span> <span class="dv">300</span>))),</a>
<a class="sourceLine" id="cb17-9" data-line-number="9">                            <span class="dt">Q_fit_args =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">fit_type =</span> <span class="st">"glm"</span>,</a>
<a class="sourceLine" id="cb17-10" data-line-number="10">                                              <span class="dt">glm_formula =</span> <span class="st">"Y ~ ."</span>)</a>
<a class="sourceLine" id="cb17-11" data-line-number="11">                           )</a>
<a class="sourceLine" id="cb17-12" data-line-number="12"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/summary">summary</a></span>(tmle_hal_shift_<span class="dv">2</span>)</a></code></pre></div>
<pre><code>##       lwr_ci    param_est       upr_ci    param_var     eif_mean 
##       1.9195      2.05244      2.18538       0.0046 -1.21898e-16 
##    estimator       n_iter 
##         tmle            0</code></pre>
</div>
<div id="interlude-constructing-optimal-stacked-regressions-with-sl3" class="section level3">
<h3 class="hasAnchor">
<a href="#interlude-constructing-optimal-stacked-regressions-with-sl3" class="anchor"></a>Interlude: Constructing Optimal Stacked Regressions with <code>sl3</code>
</h3>
<p>To easily incorporate ensemble machine learning into the estimation procedure, we rely on the facilities provided in the <a href="https://sl3.tlverse.org"><code>sl3</code> R package</a>. For a complete guide on using the <code>sl3</code> R package, consider consulting <a href="https://sl3.tlverse.org" class="uri">https://sl3.tlverse.org</a>, or <a href="https://tlverse.org" class="uri">https://tlverse.org</a> for the <code>tlverse</code> ecosystem, of which <code>sl3</code> is a major part.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb19-1" data-line-number="1"><span class="co"># SL learners to be used for most fits (e.g., IPCW, outcome regression)</span></a>
<a class="sourceLine" id="cb19-2" data-line-number="2">lrnr_lib &lt;-<span class="st"> </span><span class="kw"><a href="https://tlverse.org/sl3/reference/make_learner_stack.html">make_learner_stack</a></span>(<span class="st">"Lrnr_mean"</span>, <span class="st">"Lrnr_glm_fast"</span>, <span class="st">"Lrnr_ranger"</span>)</a>
<a class="sourceLine" id="cb19-3" data-line-number="3">sl_lrn &lt;-<span class="st"> </span>Lrnr_sl<span class="op">$</span><span class="kw">new</span>(<span class="dt">learners =</span> lrnr_lib, <span class="dt">metalearner =</span> Lrnr_nnls<span class="op">$</span><span class="kw">new</span>())</a>
<a class="sourceLine" id="cb19-4" data-line-number="4"></a>
<a class="sourceLine" id="cb19-5" data-line-number="5"><span class="co"># SL learners for conditional densities to be used for the propensity score fit</span></a>
<a class="sourceLine" id="cb19-6" data-line-number="6">lrnr_dens_lib &lt;-<span class="st"> </span><span class="kw"><a href="https://tlverse.org/sl3/reference/make_learner_stack.html">make_learner_stack</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="st">"Lrnr_condensier"</span>, <span class="dt">nbins =</span> <span class="dv">35</span>,</a>
<a class="sourceLine" id="cb19-7" data-line-number="7">                                          <span class="dt">bin_estimator =</span> Lrnr_glm_fast<span class="op">$</span><span class="kw">new</span>(),</a>
<a class="sourceLine" id="cb19-8" data-line-number="8">                                          <span class="dt">bin_method =</span> <span class="st">"equal.len"</span>,</a>
<a class="sourceLine" id="cb19-9" data-line-number="9">                                          <span class="dt">pool =</span> <span class="ot">FALSE</span>),</a>
<a class="sourceLine" id="cb19-10" data-line-number="10">                                    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="st">"Lrnr_condensier"</span>, <span class="dt">nbins =</span> <span class="dv">30</span>,</a>
<a class="sourceLine" id="cb19-11" data-line-number="11">                                          <span class="dt">bin_estimator =</span> Lrnr_ranger<span class="op">$</span><span class="kw">new</span>(),</a>
<a class="sourceLine" id="cb19-12" data-line-number="12">                                          <span class="dt">bin_method =</span> <span class="st">"equal.len"</span>,</a>
<a class="sourceLine" id="cb19-13" data-line-number="13">                                          <span class="dt">pool =</span> <span class="ot">FALSE</span>),</a>
<a class="sourceLine" id="cb19-14" data-line-number="14">                                    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="st">"Lrnr_condensier"</span>, <span class="dt">nbins =</span> <span class="dv">25</span>,</a>
<a class="sourceLine" id="cb19-15" data-line-number="15">                                          <span class="dt">bin_estimator =</span> Lrnr_ranger<span class="op">$</span><span class="kw">new</span>(),</a>
<a class="sourceLine" id="cb19-16" data-line-number="16">                                          <span class="dt">bin_method =</span> <span class="st">"equal.len"</span>,</a>
<a class="sourceLine" id="cb19-17" data-line-number="17">                                          <span class="dt">pool =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb19-18" data-line-number="18">                                   )</a>
<a class="sourceLine" id="cb19-19" data-line-number="19">sl_lrn_dens &lt;-<span class="st"> </span>Lrnr_sl<span class="op">$</span><span class="kw">new</span>(<span class="dt">learners =</span> lrnr_dens_lib,</a>
<a class="sourceLine" id="cb19-20" data-line-number="20">                           <span class="dt">metalearner =</span> Lrnr_solnp_density<span class="op">$</span><span class="kw">new</span>())</a></code></pre></div>
</div>
<div id="estimating-stochastic-interventions-effects-with-stacked-regressions" class="section level3">
<h3 class="hasAnchor">
<a href="#estimating-stochastic-interventions-effects-with-stacked-regressions" class="anchor"></a>Estimating Stochastic Interventions Effects with Stacked Regressions</h3>
<p>Using the framework provided by the <a href="https://sl3.tlverse.org"><code>sl3</code> package</a>, the nuisance parameters of the TML estimator may be fit with ensemble learning, using the cross-validation framework of the Super Learner algorithm of <span class="citation">van der Laan, Polley, and Hubbard (2007)</span>.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" data-line-number="1">tmle_sl_shift_<span class="dv">1</span> &lt;-<span class="st"> </span><span class="kw"><a href="../reference/txshift.html">txshift</a></span>(<span class="dt">W =</span> W, <span class="dt">A =</span> A, <span class="dt">Y =</span> Y, <span class="dt">delta =</span> delta,</a>
<a class="sourceLine" id="cb20-2" data-line-number="2">                           <span class="dt">fluc_method =</span> <span class="st">"standard"</span>,</a>
<a class="sourceLine" id="cb20-3" data-line-number="3">                           <span class="dt">g_fit_args =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">fit_type =</span> <span class="st">"sl"</span>,</a>
<a class="sourceLine" id="cb20-4" data-line-number="4">                                             <span class="dt">sl_lrnrs =</span> sl_lrn_dens),</a>
<a class="sourceLine" id="cb20-5" data-line-number="5">                           <span class="dt">Q_fit_args =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">fit_type =</span> <span class="st">"sl"</span>,</a>
<a class="sourceLine" id="cb20-6" data-line-number="6">                                             <span class="dt">sl_lrnrs =</span> sl_lrn)</a>
<a class="sourceLine" id="cb20-7" data-line-number="7">                          )</a></code></pre></div>
<pre><code>## 
## Iter: 1 fn: 3284.3548     Pars:  0.62285 0.01275 0.36440
## Iter: 2 fn: 3284.3548     Pars:  0.62285 0.01275 0.36441
## solnp--&gt; Completed in 2 iterations</code></pre>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb22-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/summary">summary</a></span>(tmle_sl_shift_<span class="dv">1</span>)</a></code></pre></div>
<pre><code>##      lwr_ci   param_est      upr_ci   param_var    eif_mean   estimator 
##     1.91065     2.03905     2.16745     0.00429 1.79777e-10        tmle 
##      n_iter 
##           0</code></pre>
<p>As before, we may vary the regression for the submodel fluctuation procedure by weighting each observation by the value of the so-called clever covariate rather than using such an auxiliary covariate directly in the regression procedure:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb24-1" data-line-number="1">tmle_sl_shift_<span class="dv">2</span> &lt;-<span class="st"> </span><span class="kw"><a href="../reference/txshift.html">txshift</a></span>(<span class="dt">W =</span> W, <span class="dt">A =</span> A, <span class="dt">Y =</span> Y, <span class="dt">delta =</span> delta,</a>
<a class="sourceLine" id="cb24-2" data-line-number="2">                           <span class="dt">fluc_method =</span> <span class="st">"weighted"</span>,</a>
<a class="sourceLine" id="cb24-3" data-line-number="3">                           <span class="dt">g_fit_args =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">fit_type =</span> <span class="st">"sl"</span>,</a>
<a class="sourceLine" id="cb24-4" data-line-number="4">                                             <span class="dt">sl_lrnrs =</span> sl_lrn_dens),</a>
<a class="sourceLine" id="cb24-5" data-line-number="5">                           <span class="dt">Q_fit_args =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">fit_type =</span> <span class="st">"sl"</span>,</a>
<a class="sourceLine" id="cb24-6" data-line-number="6">                                             <span class="dt">sl_lrnrs =</span> sl_lrn)</a>
<a class="sourceLine" id="cb24-7" data-line-number="7">                          )</a></code></pre></div>
<pre><code>## 
## Iter: 1 fn: 3371.7552     Pars:  0.6783688491 0.0000001068 0.3216310423
## Iter: 2 fn: 3371.7552     Pars:  0.67836887189 0.00000006801 0.32163106010
## solnp--&gt; Completed in 2 iterations</code></pre>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb26-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/summary">summary</a></span>(tmle_sl_shift_<span class="dv">2</span>)</a></code></pre></div>
<pre><code>##      lwr_ci   param_est      upr_ci   param_var    eif_mean   estimator 
##      1.9207     2.04911     2.17751     0.00429 9.55362e-14        tmle 
##      n_iter 
##           0</code></pre>
</div>
<div id="statistical-inference-for-targeted-maximum-likelihood-estimates" class="section level3">
<h3 class="hasAnchor">
<a href="#statistical-inference-for-targeted-maximum-likelihood-estimates" class="anchor"></a>Statistical Inference for Targeted Maximum Likelihood Estimates</h3>
<p>Recall that the asymptotic distribution of TML estimators has been studied thoroughly: <span class="math display">\[\psi_n - \psi_0 = (P_n - P_0) \cdot D(\bar{Q}_n^*, g_n) + R(\hat{P}^*, P_0),\]</span> which, provided the following two conditions:</p>
<ol style="list-style-type: decimal">
<li>If <span class="math inline">\(D(\bar{Q}_n^*, g_n)\)</span> converges to <span class="math inline">\(D(P_0)\)</span> in <span class="math inline">\(L_2(P_0)\)</span> norm, and</li>
<li>the size of the class of functions considered for estimation of <span class="math inline">\(\bar{Q}_n^*\)</span> and <span class="math inline">\(g_n\)</span> is bounded (technically, <span class="math inline">\(\exists \mathcal{F}\)</span> st <span class="math inline">\(D(\bar{Q}_n^*, g_n) \in \mathcal{F}\)</span> <em><strong>whp</strong></em>, where <span class="math inline">\(\mathcal{F}\)</span> is a Donsker class), readily admits the conclusion that <span class="math inline">\(\psi_n - \psi_0 = (P_n - P_0) \cdot D(P_0) + R(\hat{P}^*, P_0)\)</span>.</li>
</ol>
<p>Under the additional condition that the remainder term <span class="math inline">\(R(\hat{P}^*, P_0)\)</span> decays as <span class="math inline">\(o_P \left( \frac{1}{\sqrt{n}} \right),\)</span> we have that <span class="math display">\[\psi_n - \psi_0 = (P_n - P_0) \cdot D(P_0) + o_P \left( \frac{1}{\sqrt{n}}
 \right),\]</span> which, by a central limit theorem, establishes a Gaussian limiting distribution for the estimator:</p>
<p><span class="math display">\[\sqrt{n}(\psi_n - \psi) \to N(0, V(D(P_0))),\]</span> where <span class="math inline">\(V(D(P_0))\)</span> is the variance of the efficient influence curve (canonical gradient) when <span class="math inline">\(\psi\)</span> admits an asymptotically linear representation.</p>
<p>The above implies that <span class="math inline">\(\psi_n\)</span> is a <span class="math inline">\(\sqrt{n}\)</span>-consistent estimator of <span class="math inline">\(\psi\)</span>, that it is asymptotically normal (as given above), and that it is locally efficient. This allows us to build Wald-type confidence intervals in a straightforward manner:</p>
<p><span class="math display">\[\psi_n \pm z_{\alpha} \cdot \frac{\sigma_n}{\sqrt{n}},\]</span> where <span class="math inline">\(\sigma_n^2\)</span> is an estimator of <span class="math inline">\(V(D(P_0))\)</span>. The estimator <span class="math inline">\(\sigma_n^2\)</span> may be obtained using the bootstrap or computed directly via the following</p>
<p><span class="math display">\[\sigma_n^2 = \frac{1}{n} \sum_{i = 1}^{n} D^2(\bar{Q}_n^*, g_n)(O_i)\]</span></p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb28-1" data-line-number="1">(ci_shift &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/confint">confint</a></span>(tmle_sl_shift_<span class="dv">1</span>))</a></code></pre></div>
<pre><code>##   lwr_ci      est   upr_ci 
## 1.910654 2.039054 2.167454</code></pre>
<hr>
</div>
</div>
<div id="advanced-usage-user-specified-regressions" class="section level2">
<h2 class="hasAnchor">
<a href="#advanced-usage-user-specified-regressions" class="anchor"></a><em>Advanced Usage:</em> User-Specified Regressions</h2>
<p>In some special cases it may be useful for the experienced user to compute the treatment mechanism and outcome regressions separately (i.e., outside of the <code>tmle_txshift</code> wrapper function), instead applying this user-facing wrapper only to invoke the <em>targeting</em> steps involved in computing the TML estimator for the treatment shift parameter. In such cases, the optional arguments <code>gn_fit_spec</code> and <code>Qn_fit_spec</code> may be utilized. We present a case of using these here:</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb30-1" data-line-number="1"><span class="co"># compute treatment mechanism (propensity score) externally</span></a>
<a class="sourceLine" id="cb30-2" data-line-number="2">## first, produce the down-shifted treatment data</a>
<a class="sourceLine" id="cb30-3" data-line-number="3">gn_downshift &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">dnorm</a></span>(A <span class="op">-</span><span class="st"> </span>delta, <span class="dt">mean =</span> tx_mult <span class="op">*</span><span class="st"> </span>W, <span class="dt">sd =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb30-4" data-line-number="4">## next, initialize and produce the up-shifted treatment data</a>
<a class="sourceLine" id="cb30-5" data-line-number="5">gn_upshift &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">dnorm</a></span>(A <span class="op">+</span><span class="st"> </span>delta, <span class="dt">mean =</span> tx_mult <span class="op">*</span><span class="st"> </span>W, <span class="dt">sd =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb30-6" data-line-number="6">## now, initialize and produce the up-up-shifted (2 * delta) treatment data</a>
<a class="sourceLine" id="cb30-7" data-line-number="7">gn_upupshift &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">dnorm</a></span>(A <span class="op">+</span><span class="st"> </span><span class="dv">2</span> <span class="op">*</span><span class="st"> </span>delta, <span class="dt">mean =</span> tx_mult <span class="op">*</span><span class="st"> </span>W, <span class="dt">sd =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb30-8" data-line-number="8">## then, initialize and produce the un-shifted treatment data</a>
<a class="sourceLine" id="cb30-9" data-line-number="9">gn_noshift &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">dnorm</a></span>(A, <span class="dt">mean =</span> tx_mult <span class="op">*</span><span class="st"> </span>W, <span class="dt">sd =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb30-10" data-line-number="10">## finally, put it all together into an object like what's produced internally</a>
<a class="sourceLine" id="cb30-11" data-line-number="11">gn_out &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/data.table/topics/as.data.table">as.data.table</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cbind">cbind</a></span>(gn_downshift, gn_noshift, gn_upshift,</a>
<a class="sourceLine" id="cb30-12" data-line-number="12">                              gn_upupshift))</a>
<a class="sourceLine" id="cb30-13" data-line-number="13"><span class="kw"><a href="https://www.rdocumentation.org/packages/data.table/topics/setattr">setnames</a></span>(gn_out, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"downshift"</span>, <span class="st">"noshift"</span>, <span class="st">"upshift"</span>, <span class="st">"upupshift"</span>))</a>
<a class="sourceLine" id="cb30-14" data-line-number="14"></a>
<a class="sourceLine" id="cb30-15" data-line-number="15"><span class="co"># compute outcome regression externally</span></a>
<a class="sourceLine" id="cb30-16" data-line-number="16">Qn_noshift &lt;-<span class="st"> </span>(W <span class="op">+</span><span class="st"> </span>A <span class="op">-</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Extremes">min</a></span>(Y)) <span class="op">/</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/diff">diff</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/range">range</a></span>(Y))</a>
<a class="sourceLine" id="cb30-17" data-line-number="17">Qn_upshift &lt;-<span class="st"> </span>(W <span class="op">+</span><span class="st"> </span>A <span class="op">+</span><span class="st"> </span>delta <span class="op">-</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Extremes">min</a></span>(Y)) <span class="op">/</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/diff">diff</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/range">range</a></span>(Y))</a>
<a class="sourceLine" id="cb30-18" data-line-number="18">Qn_noshift[Qn_noshift <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span>] &lt;-<span class="st"> </span>.Machine<span class="op">$</span>double.neg.eps</a>
<a class="sourceLine" id="cb30-19" data-line-number="19">Qn_noshift[Qn_noshift <span class="op">&gt;</span><span class="st"> </span><span class="dv">1</span>] &lt;-<span class="st"> </span><span class="dv">1</span> <span class="op">-</span><span class="st"> </span>.Machine<span class="op">$</span>double.neg.eps</a>
<a class="sourceLine" id="cb30-20" data-line-number="20">Qn_upshift[Qn_upshift <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span>] &lt;-<span class="st"> </span>.Machine<span class="op">$</span>double.neg.eps</a>
<a class="sourceLine" id="cb30-21" data-line-number="21">Qn_upshift[Qn_upshift <span class="op">&gt;</span><span class="st"> </span><span class="dv">1</span>] &lt;-<span class="st"> </span><span class="dv">1</span> <span class="op">-</span><span class="st"> </span>.Machine<span class="op">$</span>double.neg.eps</a>
<a class="sourceLine" id="cb30-22" data-line-number="22">Qn_out &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/data.table/topics/as.data.table">as.data.table</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cbind">cbind</a></span>(Qn_noshift, Qn_upshift))</a>
<a class="sourceLine" id="cb30-23" data-line-number="23"><span class="kw"><a href="https://www.rdocumentation.org/packages/data.table/topics/setattr">setnames</a></span>(Qn_out, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"noshift"</span>, <span class="st">"upshift"</span>))</a>
<a class="sourceLine" id="cb30-24" data-line-number="24"></a>
<a class="sourceLine" id="cb30-25" data-line-number="25"><span class="co"># invoke the wrapper function only to apply the targeting step</span></a>
<a class="sourceLine" id="cb30-26" data-line-number="26">tmle_shift_spec &lt;-<span class="st"> </span><span class="kw"><a href="../reference/txshift.html">txshift</a></span>(<span class="dt">W =</span> W, <span class="dt">A =</span> A, <span class="dt">Y =</span> Y, <span class="dt">delta =</span> delta,</a>
<a class="sourceLine" id="cb30-27" data-line-number="27">                           <span class="dt">fluc_method =</span> <span class="st">"standard"</span>,</a>
<a class="sourceLine" id="cb30-28" data-line-number="28">                           <span class="dt">ipcw_fit_args =</span> <span class="ot">NULL</span>,</a>
<a class="sourceLine" id="cb30-29" data-line-number="29">                           <span class="dt">g_fit_args =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">fit_type =</span> <span class="st">"fit_spec"</span>),</a>
<a class="sourceLine" id="cb30-30" data-line-number="30">                           <span class="dt">Q_fit_args =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">fit_type =</span> <span class="st">"fit_spec"</span>),</a>
<a class="sourceLine" id="cb30-31" data-line-number="31">                           <span class="dt">gn_fit_spec =</span> gn_out,</a>
<a class="sourceLine" id="cb30-32" data-line-number="32">                           <span class="dt">Qn_fit_spec =</span> Qn_out)</a>
<a class="sourceLine" id="cb30-33" data-line-number="33"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/summary">summary</a></span>(tmle_shift_spec)</a></code></pre></div>
<pre><code>##      lwr_ci   param_est      upr_ci   param_var    eif_mean   estimator 
##       1.933     2.06887     2.20473     0.00481 1.90217e-11        tmle 
##      n_iter 
##           0</code></pre>
<hr>
</div>
<div id="references" class="section level2 unnumbered">
<h2 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h2>
<div id="refs" class="references">
<div id="ref-diaz2012population">
<p>Díaz, Iván, and Mark J van der Laan. 2012. “Population Intervention Causal Effects Based on Stochastic Interventions.” <em>Biometrics</em> 68 (2). Wiley Online Library: 541–49.</p>
</div>
<div id="ref-diaz2018stochastic">
<p>———. 2018. “Stochastic Treatment Regimes.” In <em>Targeted Learning in Data Science: Causal Inference for Complex Longitudinal Studies</em>, 167–80. Springer Science &amp; Business Media.</p>
</div>
<div id="ref-vdl2007super">
<p>van der Laan, Mark J, Eric C Polley, and Alan E Hubbard. 2007. “Super Learner.” <em>Statistical Applications in Genetics and Molecular Biology</em> 6 (1).</p>
</div>
<div id="ref-vdl2011targeted">
<p>van der Laan, Mark J, and Sherri Rose. 2011. <em>Targeted Learning: Causal Inference for Observational and Experimental Data</em>. Springer Science &amp; Business Media.</p>
</div>
<div id="ref-vdl2018targeted">
<p>———. 2018. <em>Targeted Learning in Data Science: Causal Inference for Complex Longitudinal Studies</em>. Springer Science &amp; Business Media.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#introduction">Introduction</a></li>
      <li><a href="#data-and-notation">Data and Notation</a></li>
      <li><a href="#methodology">Methodology</a></li>
      <li><a href="#advanced-usage-user-specified-regressions"><em>Advanced Usage:</em> User-Specified Regressions</a></li>
      <li><a href="#references">References</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Nima Hejazi, David Benkeser.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.</p>
</div>
      </footer>
</div>

  

  </body>
</html>
