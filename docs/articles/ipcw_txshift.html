<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IPCW-TMLEs with Stochastic Treatment Regimes • txshift</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="IPCW-TMLEs with Stochastic Treatment Regimes">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">txshift</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.3.2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/intro_txshift.html">Targeted Learning with Stochastic Treatment Regimes</a>
    </li>
    <li>
      <a href="../articles/ipcw_txshift.html">IPCW-TMLEs with Stochastic Treatment Regimes</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/nhejazi/txshift">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>IPCW-TMLEs with Stochastic Treatment Regimes</h1>
                        <h4 class="author">
<a href="https://nimahejazi.org">Nima Hejazi</a> and <a href="https://www.benkeserstatistics.com/">David Benkeser</a>
</h4>
            
            <h4 class="date">2020-03-06</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/nhejazi/txshift/blob/master/vignettes/ipcw_txshift.Rmd"><code>vignettes/ipcw_txshift.Rmd</code></a></small>
      <div class="hidden name"><code>ipcw_txshift.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level2">
<h2 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h2>
<p>For a more general introduction to the targeted maximum likelihood estimator introduced in <span class="citation">Díaz and van der Laan (2018)</span> and the corresponding software implementation found in this package, a better resource to consult is the introductory vignette. This document builds on that work, describing an inverse probability of censoring weighted TML estimator (IPCW-TMLE) for the same target parameter when a censoring process is introduced into the observed data structure. In this case the observed data structure may be denoted <span class="math inline">\(O = (W, \Delta A, Y)\)</span>, where <span class="math inline">\(W\)</span> is a set of baseline covariates, <span class="math inline">\(A\)</span> is a continuous-valued treatment or intervention, <span class="math inline">\(Y\)</span> is an outcome of interest, and <span class="math inline">\(\Delta\)</span> is an indicator of censoring (<span class="math inline">\(1\)</span> corresponding to being observed, <span class="math inline">\(0\)</span> to being missing). Perhaps the best way to appreciate the utilities provided for computing IPCW-TMLEs in this R package is to work through examples, so let’s simply jump to that.</p>
<p>To start, let’s load the packages we’ll use and set a seed for simulation:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(data.table)</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(haldensify)</a></code></pre></div>
<pre><code>## haldensify v0.0.5: Highly Adaptive Lasso Conditional Density Estimation</code></pre>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(sl3)</a>
<a class="sourceLine" id="cb3-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(txshift)</a></code></pre></div>
<pre><code>## txshift v0.3.2: Efficient Estimation of the Causal Effects of Stochastic Interventions</code></pre>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="dv">429153</span>)</a></code></pre></div>
<hr>
</div>
<div id="data-and-notation" class="section level2">
<h2 class="hasAnchor">
<a href="#data-and-notation" class="anchor"></a>Data and Notation</h2>
<p>Consider <span class="math inline">\(n\)</span> observed units <span class="math inline">\(O_1, \ldots, O_n\)</span>, where each random variable <span class="math inline">\(O = (W, A, Y)\)</span> corresponds to a single observational unit. Let <span class="math inline">\(W\)</span> denote baseline covariates (e.g., age, sex, education level), <span class="math inline">\(A\)</span> an intervention variable of interest (e.g., nutritional supplements), <span class="math inline">\(Y\)</span> an outcome of interest (e.g., disease status), and <span class="math inline">\(\Delta\)</span> a sampling process that masks the full data structure. Though it need not be the case, let <span class="math inline">\(A\)</span> be continuous-valued, i.e. <span class="math inline">\(A \in \mathbb{R}\)</span>. Let <span class="math inline">\(O_i \sim \mathcal{P} \in \mathcal{M}\)</span>, where <span class="math inline">\(\mathcal{M}\)</span> is the nonparametric statistical model defined as the set of continuous densities on <span class="math inline">\(O\)</span> with respect to some dominating measure. To formalize the definition of stochastic interventions and their corresponding causal effects, we introduce a nonparametric structural equation model (NPSEM), based on <span class="citation">Pearl (2000)</span>, to define how the system changes under posited interventions: <span class="math display">\[\begin{align*}\label{eqn:npsem}
  W &amp;= f_W(U_W) \\ \Delta &amp;= f_{\Delta}(W, U_{\Delta}) \\ A &amp;= f_A(W, U_A) \\
  Y &amp;= f_Y(A, W, U_Y),
\end{align*}\]</span> We denote the observed data structure <span class="math inline">\(O = (W, \Delta, \Delta A, Y)\)</span>, in which some observations are missing — for now, let us consider a simple case-control sampling mechanism wherein the treatment is partially censored. The sampling mechanism <span class="math inline">\(\Delta \in \{0, 1\}\)</span> allows units assigned <span class="math inline">\(1\)</span> to be observed and forces those assigned <span class="math inline">\(0\)</span> to be censored.</p>
<p>Letting <span class="math inline">\(A\)</span> denote a continuous-valued treatment, we assume that the distribution of <span class="math inline">\(A\)</span> conditional on <span class="math inline">\(W = w\)</span> has support in the interval <span class="math inline">\((l(w), u(w))\)</span> – for convenience, let this support be <em>a.e.</em> That is, the minimum natural value of treatment <span class="math inline">\(A\)</span> for an individual with covariates <span class="math inline">\(W = w\)</span> is <span class="math inline">\(l(w)\)</span>; similarly, the maximum is <span class="math inline">\(u(w)\)</span>. Then, a simple stochastic intervention, based on a shift <span class="math inline">\(\delta\)</span>, may be defined <span class="math display">\[\begin{equation}\label{eqn:shift}
  d(a, w) =
  \begin{cases}
    a - \delta &amp; \text{if } a &gt; l(w) + \delta \\
    a &amp; \text{if } a \leq l(w) + \delta,
  \end{cases}
\end{equation}\]</span> where <span class="math inline">\(0 \leq \delta \leq u(w)\)</span> is an arbitrary pre-specified value that defines the degree to which the observed value <span class="math inline">\(A\)</span> is to be shifted, where possible. For the purpose of using such a shift in practice, the present software provides estimators for a shift function that assumes that the density of treatment <span class="math inline">\(A\)</span>, conditional on the covariates <span class="math inline">\(W\)</span>, has support <em>a.e.</em></p>
<div id="simulate-data" class="section level3">
<h3 class="hasAnchor">
<a href="#simulate-data" class="anchor"></a>Simulate Data</h3>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="co"># simulate simple data for tmle-shift sketch</span></a>
<a class="sourceLine" id="cb6-2" data-line-number="2">n_obs &lt;-<span class="st"> </span><span class="dv">1000</span>  <span class="co"># sample size</span></a>
<a class="sourceLine" id="cb6-3" data-line-number="3">n_w &lt;-<span class="st"> </span><span class="dv">1</span>  <span class="co"># just one baseline covariate for this example</span></a>
<a class="sourceLine" id="cb6-4" data-line-number="4">tx_mult &lt;-<span class="st"> </span><span class="dv">2</span>  <span class="co"># multiplier for the effect of W = 1 on the treatment</span></a>
<a class="sourceLine" id="cb6-5" data-line-number="5"></a>
<a class="sourceLine" id="cb6-6" data-line-number="6"><span class="co"># baseline covariate -- simple, binary</span></a>
<a class="sourceLine" id="cb6-7" data-line-number="7">W &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/lapply.html">replicate</a></span>(n_w, <span class="kw"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span>(n_obs, <span class="dv">1</span>, <span class="fl">0.5</span>)))</a>
<a class="sourceLine" id="cb6-8" data-line-number="8"></a>
<a class="sourceLine" id="cb6-9" data-line-number="9"><span class="co"># set and organize treatment based on baseline W</span></a>
<a class="sourceLine" id="cb6-10" data-line-number="10">A &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="kw"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span>(n_obs, <span class="dt">mean =</span> tx_mult <span class="op">*</span><span class="st"> </span>W, <span class="dt">sd =</span> <span class="dv">1</span>))</a>
<a class="sourceLine" id="cb6-11" data-line-number="11"></a>
<a class="sourceLine" id="cb6-12" data-line-number="12"><span class="co"># create outcome as linear function of A, W + white noise</span></a>
<a class="sourceLine" id="cb6-13" data-line-number="13">Y &lt;-<span class="st"> </span>A <span class="op">+</span><span class="st"> </span>W <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span>(n_obs, <span class="dt">mean =</span> <span class="dv">0</span>, <span class="dt">sd =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb6-14" data-line-number="14"></a>
<a class="sourceLine" id="cb6-15" data-line-number="15"><span class="co"># censoring based on covariates</span></a>
<a class="sourceLine" id="cb6-16" data-line-number="16">C &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span>(n_obs, <span class="dv">1</span>, <span class="kw"><a href="https://rdrr.io/r/stats/Logistic.html">plogis</a></span>(W))</a>
<a class="sourceLine" id="cb6-17" data-line-number="17"></a>
<a class="sourceLine" id="cb6-18" data-line-number="18"><span class="co"># treatment shift parameter</span></a>
<a class="sourceLine" id="cb6-19" data-line-number="19">delta &lt;-<span class="st"> </span><span class="fl">0.5</span></a></code></pre></div>
</div>
</div>
<div id="methodology" class="section level2">
<h2 class="hasAnchor">
<a href="#methodology" class="anchor"></a>Methodology</h2>
<p><strong>Note:</strong> In all examples below, the argument <code>eif_reg_type</code> is set to <code>"glm"</code> (whereas the default is <code>"hal"</code>) when invoking an IPCW-TMLE. This is done in an effort to speed along the computation process, as this argument controls the manner in which a nuisance regression associated with the efficient influence function of the IPCW-TMLE is fit. As stated in the documentation, setting this argument to <code>"glm"</code> fits this EIF nuisance regression with a generalized linear model (GLM; an assumption-laden parametric form) while the default value of <code>"hal"</code> fits the nuisance regression with the highly adaptive lasso (HAL; a recently developed nonparametric estimator) via the <a href="https://github.com/tlverse/hal9001"><code>hal9001</code> R package</a> <span class="citation">(Coyle, Hejazi, and van der Laan 2019)</span>. In practice, we recommend leaving this argument to the default and fitting the EIF nuisance regression with HAL; however, this is significantly slower than simple using a GLM.</p>
<div id="inverse-probability-weighting-with-targeted-maximum-likelihood-estimation" class="section level3">
<h3 class="hasAnchor">
<a href="#inverse-probability-weighting-with-targeted-maximum-likelihood-estimation" class="anchor"></a>Inverse Probability Weighting with Targeted Maximum Likelihood Estimation</h3>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1">tmle_hal_shift_<span class="dv">1</span> &lt;-<span class="st"> </span><span class="kw"><a href="../reference/txshift.html">txshift</a></span>(<span class="dt">W =</span> W, <span class="dt">A =</span> A, <span class="dt">Y =</span> Y,</a>
<a class="sourceLine" id="cb7-2" data-line-number="2">                            <span class="dt">C =</span> C, <span class="dt">V =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"W"</span>, <span class="st">"Y"</span>),</a>
<a class="sourceLine" id="cb7-3" data-line-number="3">                            <span class="dt">delta =</span> delta,</a>
<a class="sourceLine" id="cb7-4" data-line-number="4">                            <span class="dt">fluctuation =</span> <span class="st">"standard"</span>,</a>
<a class="sourceLine" id="cb7-5" data-line-number="5">                            <span class="dt">max_iter =</span> <span class="dv">2</span>,</a>
<a class="sourceLine" id="cb7-6" data-line-number="6">                            <span class="dt">ipcw_fit_args =</span> <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">fit_type =</span> <span class="st">"glm"</span>),</a>
<a class="sourceLine" id="cb7-7" data-line-number="7">                            <span class="dt">g_fit_args =</span> <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">fit_type =</span> <span class="st">"hal"</span>,</a>
<a class="sourceLine" id="cb7-8" data-line-number="8">                                              <span class="dt">n_bins =</span> <span class="dv">5</span>,</a>
<a class="sourceLine" id="cb7-9" data-line-number="9">                                              <span class="dt">grid_type =</span> <span class="st">"equal_mass"</span>,</a>
<a class="sourceLine" id="cb7-10" data-line-number="10">                                              <span class="dt">lambda_seq =</span></a>
<a class="sourceLine" id="cb7-11" data-line-number="11">                                                <span class="kw"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="op">-</span><span class="dv">1</span>, <span class="dv">-9</span>,</a>
<a class="sourceLine" id="cb7-12" data-line-number="12">                                                        <span class="dt">length =</span> <span class="dv">300</span>))),</a>
<a class="sourceLine" id="cb7-13" data-line-number="13">                            <span class="dt">Q_fit_args =</span> <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">fit_type =</span> <span class="st">"glm"</span>,</a>
<a class="sourceLine" id="cb7-14" data-line-number="14">                                              <span class="dt">glm_formula =</span> <span class="st">"Y ~ ."</span>),</a>
<a class="sourceLine" id="cb7-15" data-line-number="15">                            <span class="dt">eif_reg_type =</span> <span class="st">"glm"</span></a>
<a class="sourceLine" id="cb7-16" data-line-number="16">                           )</a>
<a class="sourceLine" id="cb7-17" data-line-number="17"><span class="kw"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(tmle_hal_shift_<span class="dv">1</span>)</a></code></pre></div>
<pre><code>##     lwr_ci  param_est     upr_ci  param_var   eif_mean  estimator     n_iter 
##     1.9424      2.078     2.2135     0.0048 3.6786e-05       tmle          1</code></pre>
<p>When computing any such TML estimator, we may, of course, vary the regressions used in fitting the nuisance parameters; however, an even simpler variation is to fit the step for the fluctuation submodels with a <em>weighted</em> method, simply weighting each observation by an auxiliary covariate (often denoted <span class="math inline">\(H_n\)</span>, and sometimes called the “clever covariate” in the literature) rather than using such a covariate directly in the submodel regression fit.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1">tmle_hal_shift_<span class="dv">2</span> &lt;-<span class="st"> </span><span class="kw"><a href="../reference/txshift.html">txshift</a></span>(<span class="dt">W =</span> W, <span class="dt">A =</span> A, <span class="dt">Y =</span> Y,</a>
<a class="sourceLine" id="cb9-2" data-line-number="2">                            <span class="dt">C =</span> C, <span class="dt">V =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"W"</span>, <span class="st">"Y"</span>),</a>
<a class="sourceLine" id="cb9-3" data-line-number="3">                            <span class="dt">delta =</span> delta,</a>
<a class="sourceLine" id="cb9-4" data-line-number="4">                            <span class="dt">fluctuation =</span> <span class="st">"weighted"</span>,</a>
<a class="sourceLine" id="cb9-5" data-line-number="5">                            <span class="dt">max_iter =</span> <span class="dv">2</span>,</a>
<a class="sourceLine" id="cb9-6" data-line-number="6">                            <span class="dt">ipcw_fit_args =</span> <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">fit_type =</span> <span class="st">"glm"</span>),</a>
<a class="sourceLine" id="cb9-7" data-line-number="7">                            <span class="dt">g_fit_args =</span> <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">fit_type =</span> <span class="st">"hal"</span>,</a>
<a class="sourceLine" id="cb9-8" data-line-number="8">                                              <span class="dt">n_bins =</span> <span class="dv">5</span>,</a>
<a class="sourceLine" id="cb9-9" data-line-number="9">                                              <span class="dt">grid_type =</span> <span class="st">"equal_mass"</span>,</a>
<a class="sourceLine" id="cb9-10" data-line-number="10">                                              <span class="dt">lambda_seq =</span></a>
<a class="sourceLine" id="cb9-11" data-line-number="11">                                                <span class="kw"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="op">-</span><span class="dv">1</span>, <span class="dv">-9</span>,</a>
<a class="sourceLine" id="cb9-12" data-line-number="12">                                                        <span class="dt">length =</span> <span class="dv">300</span>))),</a>
<a class="sourceLine" id="cb9-13" data-line-number="13">                            <span class="dt">Q_fit_args =</span> <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">fit_type =</span> <span class="st">"glm"</span>,</a>
<a class="sourceLine" id="cb9-14" data-line-number="14">                                              <span class="dt">glm_formula =</span> <span class="st">"Y ~ ."</span>),</a>
<a class="sourceLine" id="cb9-15" data-line-number="15">                            <span class="dt">eif_reg_type =</span> <span class="st">"glm"</span></a>
<a class="sourceLine" id="cb9-16" data-line-number="16">                           )</a>
<a class="sourceLine" id="cb9-17" data-line-number="17"><span class="kw"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(tmle_hal_shift_<span class="dv">2</span>)</a></code></pre></div>
<pre><code>##     lwr_ci  param_est     upr_ci  param_var   eif_mean  estimator     n_iter 
##     1.9425      2.078     2.2136     0.0048 3.6791e-05       tmle          1</code></pre>
</div>
<div id="interlude-constructing-optimal-stacked-regressions-with-sl3" class="section level3">
<h3 class="hasAnchor">
<a href="#interlude-constructing-optimal-stacked-regressions-with-sl3" class="anchor"></a>Interlude: Constructing Optimal Stacked Regressions with <code>sl3</code>
</h3>
<p>To easily incorporate ensemble machine learning into the estimation procedure, we rely on the facilities provided in the <a href="https://sl3.tlverse.org"><code>sl3</code> R package</a> <span class="citation">(Coyle et al. 2020)</span>. For a complete guide on using the <code>sl3</code> R package, consider consulting <a href="https://tlverse.org/sl3" class="uri">https://tlverse.org/sl3</a>.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="co"># SL learners to be used for most fits (e.g., IPCW, outcome regression)</span></a>
<a class="sourceLine" id="cb11-2" data-line-number="2">lrnr_lib &lt;-<span class="st"> </span><span class="kw"><a href="https://tlverse.org/sl3/reference/make_learner_stack.html">make_learner_stack</a></span>(<span class="st">"Lrnr_mean"</span>, <span class="st">"Lrnr_glm"</span>, <span class="st">"Lrnr_xgboost"</span>)</a>
<a class="sourceLine" id="cb11-3" data-line-number="3">sl_learner &lt;-<span class="st"> </span>Lrnr_sl<span class="op">$</span><span class="kw">new</span>(<span class="dt">learners =</span> lrnr_lib, <span class="dt">metalearner =</span> Lrnr_nnls<span class="op">$</span><span class="kw">new</span>())</a>
<a class="sourceLine" id="cb11-4" data-line-number="4"></a>
<a class="sourceLine" id="cb11-5" data-line-number="5"><span class="co"># SL learners for conditional densities to be used for the propensity score fit</span></a>
<a class="sourceLine" id="cb11-6" data-line-number="6">lrnr_dens_lib &lt;-<span class="st"> </span><span class="kw"><a href="https://tlverse.org/sl3/reference/make_learner_stack.html">make_learner_stack</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="st">"Lrnr_haldensify"</span>, <span class="dt">n_bins =</span> <span class="dv">5</span>,</a>
<a class="sourceLine" id="cb11-7" data-line-number="7">                                          <span class="dt">grid_type =</span> <span class="st">"equal_range"</span>,</a>
<a class="sourceLine" id="cb11-8" data-line-number="8">                                          <span class="dt">lambda_seq =</span> <span class="kw"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="op">-</span><span class="dv">1</span>, <span class="dv">-7</span>,</a>
<a class="sourceLine" id="cb11-9" data-line-number="9">                                                               <span class="dt">length =</span> <span class="dv">100</span>))),</a>
<a class="sourceLine" id="cb11-10" data-line-number="10">                                    <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="st">"Lrnr_haldensify"</span>, <span class="dt">n_bins =</span> <span class="dv">5</span>,</a>
<a class="sourceLine" id="cb11-11" data-line-number="11">                                          <span class="dt">bin_method =</span> <span class="st">"equal_mass"</span>,</a>
<a class="sourceLine" id="cb11-12" data-line-number="12">                                          <span class="dt">lambda_seq =</span> <span class="kw"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="op">-</span><span class="dv">1</span>, <span class="dv">-7</span>,</a>
<a class="sourceLine" id="cb11-13" data-line-number="13">                                                               <span class="dt">length =</span> <span class="dv">100</span>))),</a>
<a class="sourceLine" id="cb11-14" data-line-number="14">                                    <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="st">"Lrnr_haldensify"</span>, <span class="dt">nbins =</span> <span class="dv">10</span>,</a>
<a class="sourceLine" id="cb11-15" data-line-number="15">                                          <span class="dt">bin_method =</span> <span class="st">"equal_mass"</span>,</a>
<a class="sourceLine" id="cb11-16" data-line-number="16">                                          <span class="dt">lambda_seq =</span> <span class="kw"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="op">-</span><span class="dv">1</span>, <span class="dv">-9</span>,</a>
<a class="sourceLine" id="cb11-17" data-line-number="17">                                                               <span class="dt">length =</span> <span class="dv">300</span>)))</a>
<a class="sourceLine" id="cb11-18" data-line-number="18">                                   )</a>
<a class="sourceLine" id="cb11-19" data-line-number="19">sl_learner_density &lt;-<span class="st"> </span>Lrnr_sl<span class="op">$</span><span class="kw">new</span>(<span class="dt">learners =</span> lrnr_dens_lib,</a>
<a class="sourceLine" id="cb11-20" data-line-number="20">                                  <span class="dt">metalearner =</span> Lrnr_solnp_density<span class="op">$</span><span class="kw">new</span>())</a></code></pre></div>
</div>
<div id="estimating-the-ipcw-tmle-with-optimal-stacked-regressions" class="section level3">
<h3 class="hasAnchor">
<a href="#estimating-the-ipcw-tmle-with-optimal-stacked-regressions" class="anchor"></a>Estimating the IPCW-TMLE with Optimal Stacked Regressions</h3>
<p>Using the framework provided by the <a href="https://tlverse.org/sl3"><code>sl3</code> package</a>, the nuisance parameters of the TML estimator may be fit with ensemble learning, using the cross-validation framework of the Super Learner algorithm of <span class="citation">van der Laan, Polley, and Hubbard (2007)</span>. In principal, it would be desirable to estimate the parameter using data-adaptive stacked regressions for the sampling mechanism (via <code>ipcw_fit_args</code>, the treatment mechanism (via <code>g_fit_args</code>), and the outcome mechanism (via <code>Q_fit_args</code>). This could be done with a call to the <code>txshift</code> function like the following; however, we avoid running the following code chunk for the sake of saving time in this vignette.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1">tmle_sl_shift_<span class="dv">1</span> &lt;-<span class="st"> </span><span class="kw"><a href="../reference/txshift.html">txshift</a></span>(<span class="dt">W =</span> W, <span class="dt">A =</span> A, <span class="dt">Y =</span> Y,</a>
<a class="sourceLine" id="cb12-2" data-line-number="2">                           <span class="dt">C =</span> C, <span class="dt">V =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"W"</span>, <span class="st">"Y"</span>),</a>
<a class="sourceLine" id="cb12-3" data-line-number="3">                           <span class="dt">delta =</span> delta,</a>
<a class="sourceLine" id="cb12-4" data-line-number="4">                           <span class="dt">fluctuation =</span> <span class="st">"standard"</span>,</a>
<a class="sourceLine" id="cb12-5" data-line-number="5">                           <span class="dt">max_iter =</span> <span class="dv">2</span>,</a>
<a class="sourceLine" id="cb12-6" data-line-number="6">                           <span class="dt">ipcw_fit_args =</span> <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">fit_type =</span> <span class="st">"sl"</span>,</a>
<a class="sourceLine" id="cb12-7" data-line-number="7">                                                <span class="dt">sl_learnrs =</span> sl_learner),</a>
<a class="sourceLine" id="cb12-8" data-line-number="8">                           <span class="dt">g_fit_args =</span> <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">fit_type =</span> <span class="st">"sl"</span>,</a>
<a class="sourceLine" id="cb12-9" data-line-number="9">                                             <span class="dt">sl_learners_density =</span></a>
<a class="sourceLine" id="cb12-10" data-line-number="10">                                               sl_learner_density),</a>
<a class="sourceLine" id="cb12-11" data-line-number="11">                           <span class="dt">Q_fit_args =</span> <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">fit_type =</span> <span class="st">"sl"</span>,</a>
<a class="sourceLine" id="cb12-12" data-line-number="12">                                             <span class="dt">sl_learners =</span> sl_learner),</a>
<a class="sourceLine" id="cb12-13" data-line-number="13">                           <span class="dt">eif_reg_type =</span> <span class="st">"glm"</span></a>
<a class="sourceLine" id="cb12-14" data-line-number="14">                          )</a>
<a class="sourceLine" id="cb12-15" data-line-number="15"><span class="kw"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(tmle_sl_shift_<span class="dv">1</span>)</a></code></pre></div>
<p>As before, we may vary the regression for the submodel fluctuation procedure by weighting each observation by the value of the auxiliary covariate rather than using such an auxiliary covariate directly in the regression procedure. Note that we again avoid running the following code chunk for the sake of saving time in this vignette.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1">tmle_sl_shift_<span class="dv">2</span> &lt;-<span class="st"> </span><span class="kw"><a href="../reference/txshift.html">txshift</a></span>(<span class="dt">W =</span> W, <span class="dt">A =</span> A, <span class="dt">Y =</span> Y,</a>
<a class="sourceLine" id="cb13-2" data-line-number="2">                           <span class="dt">C =</span> C, <span class="dt">V =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"W"</span>, <span class="st">"Y"</span>),</a>
<a class="sourceLine" id="cb13-3" data-line-number="3">                           <span class="dt">delta =</span> delta,</a>
<a class="sourceLine" id="cb13-4" data-line-number="4">                           <span class="dt">fluctuation =</span> <span class="st">"weighted"</span>,</a>
<a class="sourceLine" id="cb13-5" data-line-number="5">                           <span class="dt">max_iter =</span> <span class="dv">2</span>,</a>
<a class="sourceLine" id="cb13-6" data-line-number="6">                           <span class="dt">ipcw_fit_args =</span> <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">fit_type =</span> <span class="st">"sl"</span>,</a>
<a class="sourceLine" id="cb13-7" data-line-number="7">                                                <span class="dt">sl_learners =</span> sl_learner),</a>
<a class="sourceLine" id="cb13-8" data-line-number="8">                           <span class="dt">g_fit_args =</span> <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">fit_type =</span> <span class="st">"hal"</span>,</a>
<a class="sourceLine" id="cb13-9" data-line-number="9">                                             <span class="dt">n_bins =</span> <span class="dv">5</span>,</a>
<a class="sourceLine" id="cb13-10" data-line-number="10">                                             <span class="dt">grid_type =</span> <span class="st">"equal_mass"</span>,</a>
<a class="sourceLine" id="cb13-11" data-line-number="11">                                             <span class="dt">lambda_seq =</span></a>
<a class="sourceLine" id="cb13-12" data-line-number="12">                                               <span class="kw"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="op">-</span><span class="dv">1</span>, <span class="dv">-9</span>,</a>
<a class="sourceLine" id="cb13-13" data-line-number="13">                                                       <span class="dt">length =</span> <span class="dv">300</span>))),</a>
<a class="sourceLine" id="cb13-14" data-line-number="14">                           <span class="dt">Q_fit_args =</span> <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">fit_type =</span> <span class="st">"sl"</span>,</a>
<a class="sourceLine" id="cb13-15" data-line-number="15">                                             <span class="dt">sl_learners =</span> sl_learner),</a>
<a class="sourceLine" id="cb13-16" data-line-number="16">                           <span class="dt">eif_reg_type =</span> <span class="st">"glm"</span></a>
<a class="sourceLine" id="cb13-17" data-line-number="17">                          )</a>
<a class="sourceLine" id="cb13-18" data-line-number="18"><span class="kw"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(tmle_sl_shift_<span class="dv">2</span>)</a></code></pre></div>
</div>
<div id="estimating-inefficient-ipcw-tmles-with-optimal-stacked-regressions" class="section level3">
<h3 class="hasAnchor">
<a href="#estimating-inefficient-ipcw-tmles-with-optimal-stacked-regressions" class="anchor"></a>Estimating <em>Inefficient</em> IPCW-TMLEs with Optimal Stacked Regressions</h3>
<p>Utilizing the <code>sl3</code> R package in exactly the same manner, it is also possible to estimate <em>inefficient</em> IPCW-TML estimators with <code>txshift</code>. The inefficient IPCW-TMLE performs nearly all of the same computations as the efficient version of the estimator, eschewing only the iterative targeting procedure performed over a more complex efficient influence function; the interested reader is referred to <span class="citation">Rose and van der Laan (2011)</span> for further details on the differences between the efficient and inefficient IPCW-TMLEs. By default, an efficient IPCW-TMLE is computed when censoring is detected; however, this may be disable by setting the <code>ipcw_efficiency</code> argument to <code>FALSE</code> like so</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1">tmle_sl_ineffic &lt;-<span class="st"> </span><span class="kw"><a href="../reference/txshift.html">txshift</a></span>(<span class="dt">W =</span> W, <span class="dt">A =</span> A, <span class="dt">Y =</span> Y,</a>
<a class="sourceLine" id="cb14-2" data-line-number="2">                           <span class="dt">C =</span> C, <span class="dt">V =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"W"</span>, <span class="st">"Y"</span>),</a>
<a class="sourceLine" id="cb14-3" data-line-number="3">                           <span class="dt">delta =</span> delta,</a>
<a class="sourceLine" id="cb14-4" data-line-number="4">                           <span class="dt">fluctuation =</span> <span class="st">"standard"</span>,</a>
<a class="sourceLine" id="cb14-5" data-line-number="5">                           <span class="dt">ipcw_fit_args =</span> <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">fit_type =</span> <span class="st">"sl"</span>,</a>
<a class="sourceLine" id="cb14-6" data-line-number="6">                                                <span class="dt">sl_learners =</span> sl_learner),</a>
<a class="sourceLine" id="cb14-7" data-line-number="7">                           <span class="dt">g_fit_args =</span> <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">fit_type =</span> <span class="st">"hal"</span>,</a>
<a class="sourceLine" id="cb14-8" data-line-number="8">                                             <span class="dt">n_bins =</span> <span class="dv">5</span>,</a>
<a class="sourceLine" id="cb14-9" data-line-number="9">                                             <span class="dt">grid_type =</span> <span class="st">"equal_mass"</span>,</a>
<a class="sourceLine" id="cb14-10" data-line-number="10">                                             <span class="dt">lambda_seq =</span></a>
<a class="sourceLine" id="cb14-11" data-line-number="11">                                               <span class="kw"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="op">-</span><span class="dv">1</span>, <span class="dv">-9</span>,</a>
<a class="sourceLine" id="cb14-12" data-line-number="12">                                                       <span class="dt">length =</span> <span class="dv">300</span>))),</a>
<a class="sourceLine" id="cb14-13" data-line-number="13">                           <span class="dt">Q_fit_args =</span> <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">fit_type =</span> <span class="st">"sl"</span>,</a>
<a class="sourceLine" id="cb14-14" data-line-number="14">                                             <span class="dt">sl_learners =</span> sl_learner),</a>
<a class="sourceLine" id="cb14-15" data-line-number="15">                           <span class="dt">ipcw_efficiency =</span> <span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb14-16" data-line-number="16">                          )</a>
<a class="sourceLine" id="cb14-17" data-line-number="17"><span class="kw"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(tmle_sl_ineffic)</a></code></pre></div>
<pre><code>##      lwr_ci   param_est      upr_ci   param_var    eif_mean   estimator 
##      1.8634      2.0848      2.3062      0.0128 -1.3260e-12        tmle 
##      n_iter 
##           0</code></pre>
<p>Please note that in such cases, the value of <code>n_iter</code> in the resulting output should be <strong><em>exactly zero</em></strong>, as this indicates that the iterative procedure that is used to achieve efficiency has been skipped.</p>
</div>
<div id="statistical-inference-for-targeted-maximum-likelihood-estimates" class="section level3">
<h3 class="hasAnchor">
<a href="#statistical-inference-for-targeted-maximum-likelihood-estimates" class="anchor"></a>Statistical Inference for Targeted Maximum Likelihood Estimates</h3>
<p>For a discussion of the procedure for obtaining statistical inference for TML estimators, the interested reader is referred to the introductory vignette of this package. Here, we focus on addressing the issue of how censoring impacts the inferential procedure…</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" data-line-number="1">(ci_shift &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/confint.html">confint</a></span>(tmle_hal_shift_<span class="dv">1</span>))</a></code></pre></div>
<pre><code>##   lwr_ci      est   upr_ci 
## 1.942405 2.077960 2.213515</code></pre>
</div>
</div>
<div id="advanced-usage-user-specified-regressions" class="section level2">
<h2 class="hasAnchor">
<a href="#advanced-usage-user-specified-regressions" class="anchor"></a><em>Advanced Usage:</em> User-Specified Regressions</h2>
<p>In some special cases it may be useful for the experienced user to compute the censoring mechanism, treatment mechanism, and outcome mechanism regressions separately (i.e., outside of the <code>txshift</code> wrapper function), instead applying this user-facing wrapper only to invoke the <em>targeting</em> steps involved in computing the TML estimator for the treatment shift parameter. In such cases, the optional arguments <code>ipcw_fit_spec</code>, <code>gn_fit_spec</code> and <code>Qn_fit_spec</code> may be utilized. We present a case of using these arguments here:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" data-line-number="1"><span class="co"># compute the censoring mechanism and produce IPC weights externally</span></a>
<a class="sourceLine" id="cb18-2" data-line-number="2">pi_mech &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/Logistic.html">plogis</a></span>(W)</a>
<a class="sourceLine" id="cb18-3" data-line-number="3">ipc_weights_out &lt;-<span class="st"> </span>(<span class="kw"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(C <span class="op">==</span><span class="st"> </span><span class="dv">1</span>) <span class="op">/</span><span class="st"> </span>pi_mech)[C <span class="op">==</span><span class="st"> </span><span class="dv">1</span>]</a>
<a class="sourceLine" id="cb18-4" data-line-number="4">ipcw_out &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">pi_mech =</span> pi_mech, <span class="dt">ipc_weights =</span> ipc_weights_out)</a>
<a class="sourceLine" id="cb18-5" data-line-number="5"></a>
<a class="sourceLine" id="cb18-6" data-line-number="6"><span class="co"># compute treatment mechanism (propensity score) externally</span></a>
<a class="sourceLine" id="cb18-7" data-line-number="7">## first, produce the down-shifted treatment data</a>
<a class="sourceLine" id="cb18-8" data-line-number="8">gn_downshift &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span>(A <span class="op">-</span><span class="st"> </span>delta, <span class="dt">mean =</span> tx_mult <span class="op">*</span><span class="st"> </span>W, <span class="dt">sd =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb18-9" data-line-number="9">## next, initialize and produce the up-shifted treatment data</a>
<a class="sourceLine" id="cb18-10" data-line-number="10">gn_upshift &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span>(A <span class="op">+</span><span class="st"> </span>delta, <span class="dt">mean =</span> tx_mult <span class="op">*</span><span class="st"> </span>W, <span class="dt">sd =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb18-11" data-line-number="11">## now, initialize and produce the up-up-shifted (2 * delta) treatment data</a>
<a class="sourceLine" id="cb18-12" data-line-number="12">gn_upupshift &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span>(A <span class="op">+</span><span class="st"> </span><span class="dv">2</span> <span class="op">*</span><span class="st"> </span>delta, <span class="dt">mean =</span> tx_mult <span class="op">*</span><span class="st"> </span>W, <span class="dt">sd =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb18-13" data-line-number="13">## then, initialize and produce the un-shifted treatment data</a>
<a class="sourceLine" id="cb18-14" data-line-number="14">gn_noshift &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span>(A, <span class="dt">mean =</span> tx_mult <span class="op">*</span><span class="st"> </span>W, <span class="dt">sd =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb18-15" data-line-number="15">## finally, put it all together into an object like what's produced internally</a>
<a class="sourceLine" id="cb18-16" data-line-number="16">gn_out &lt;-<span class="st"> </span><span class="kw"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.data.table.html">as.data.table</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span>(gn_downshift, gn_noshift, gn_upshift,</a>
<a class="sourceLine" id="cb18-17" data-line-number="17">                              gn_upupshift))[C <span class="op">==</span><span class="st"> </span><span class="dv">1</span>, ]</a>
<a class="sourceLine" id="cb18-18" data-line-number="18"><span class="kw"><a href="https://Rdatatable.gitlab.io/data.table/reference/setattr.html">setnames</a></span>(gn_out, <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"downshift"</span>, <span class="st">"noshift"</span>, <span class="st">"upshift"</span>, <span class="st">"upupshift"</span>))</a>
<a class="sourceLine" id="cb18-19" data-line-number="19"></a>
<a class="sourceLine" id="cb18-20" data-line-number="20"><span class="co"># compute outcome regression externally</span></a>
<a class="sourceLine" id="cb18-21" data-line-number="21">Qn_noshift &lt;-<span class="st"> </span>(W <span class="op">+</span><span class="st"> </span>A <span class="op">-</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(Y)) <span class="op">/</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/diff.html">diff</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/range.html">range</a></span>(Y))</a>
<a class="sourceLine" id="cb18-22" data-line-number="22">Qn_upshift &lt;-<span class="st"> </span>(W <span class="op">+</span><span class="st"> </span>A <span class="op">+</span><span class="st"> </span>delta <span class="op">-</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(Y)) <span class="op">/</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/diff.html">diff</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/range.html">range</a></span>(Y))</a>
<a class="sourceLine" id="cb18-23" data-line-number="23">Qn_noshift[Qn_noshift <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span>] &lt;-<span class="st"> </span>.Machine<span class="op">$</span>double.neg.eps</a>
<a class="sourceLine" id="cb18-24" data-line-number="24">Qn_noshift[Qn_noshift <span class="op">&gt;</span><span class="st"> </span><span class="dv">1</span>] &lt;-<span class="st"> </span><span class="dv">1</span> <span class="op">-</span><span class="st"> </span>.Machine<span class="op">$</span>double.neg.eps</a>
<a class="sourceLine" id="cb18-25" data-line-number="25">Qn_upshift[Qn_upshift <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span>] &lt;-<span class="st"> </span>.Machine<span class="op">$</span>double.neg.eps</a>
<a class="sourceLine" id="cb18-26" data-line-number="26">Qn_upshift[Qn_upshift <span class="op">&gt;</span><span class="st"> </span><span class="dv">1</span>] &lt;-<span class="st"> </span><span class="dv">1</span> <span class="op">-</span><span class="st"> </span>.Machine<span class="op">$</span>double.neg.eps</a>
<a class="sourceLine" id="cb18-27" data-line-number="27">Qn_out &lt;-<span class="st"> </span><span class="kw"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.data.table.html">as.data.table</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span>(Qn_noshift, Qn_upshift))[C <span class="op">==</span><span class="st"> </span><span class="dv">1</span>, ]</a>
<a class="sourceLine" id="cb18-28" data-line-number="28"><span class="kw"><a href="https://Rdatatable.gitlab.io/data.table/reference/setattr.html">setnames</a></span>(Qn_out, <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"noshift"</span>, <span class="st">"upshift"</span>))</a>
<a class="sourceLine" id="cb18-29" data-line-number="29"></a>
<a class="sourceLine" id="cb18-30" data-line-number="30"><span class="co"># invoke the wrapper function only to apply the targeting step</span></a>
<a class="sourceLine" id="cb18-31" data-line-number="31">tmle_shift_spec &lt;-<span class="st"> </span><span class="kw"><a href="../reference/txshift.html">txshift</a></span>(<span class="dt">W =</span> W, <span class="dt">A =</span> A, <span class="dt">Y =</span> Y, <span class="dt">delta =</span> delta,</a>
<a class="sourceLine" id="cb18-32" data-line-number="32">                           <span class="dt">C =</span> C, <span class="dt">V =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"W"</span>, <span class="st">"Y"</span>),</a>
<a class="sourceLine" id="cb18-33" data-line-number="33">                           <span class="dt">fluctuation =</span> <span class="st">"standard"</span>,</a>
<a class="sourceLine" id="cb18-34" data-line-number="34">                           <span class="dt">max_iter =</span> <span class="dv">2</span>,</a>
<a class="sourceLine" id="cb18-35" data-line-number="35">                           <span class="dt">ipcw_fit_args =</span> <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">fit_type =</span> <span class="st">"fit_spec"</span>),</a>
<a class="sourceLine" id="cb18-36" data-line-number="36">                           <span class="dt">g_fit_args =</span> <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">fit_type =</span> <span class="st">"fit_spec"</span>),</a>
<a class="sourceLine" id="cb18-37" data-line-number="37">                           <span class="dt">Q_fit_args =</span> <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">fit_type =</span> <span class="st">"fit_spec"</span>),</a>
<a class="sourceLine" id="cb18-38" data-line-number="38">                           <span class="dt">ipcw_fit_spec =</span> ipcw_out,</a>
<a class="sourceLine" id="cb18-39" data-line-number="39">                           <span class="dt">gn_fit_spec =</span> gn_out,</a>
<a class="sourceLine" id="cb18-40" data-line-number="40">                           <span class="dt">Qn_fit_spec =</span> Qn_out,</a>
<a class="sourceLine" id="cb18-41" data-line-number="41">                           <span class="dt">eif_reg_type =</span> <span class="st">"glm"</span>)</a>
<a class="sourceLine" id="cb18-42" data-line-number="42"><span class="kw"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(tmle_shift_spec)</a></code></pre></div>
<pre><code>##     lwr_ci  param_est     upr_ci  param_var   eif_mean  estimator     n_iter 
##     1.9508     2.0898     2.2289      0.005 4.2686e-05       tmle          1</code></pre>
<hr>
</div>
<div id="references" class="section level2 unnumbered">
<h2 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h2>
<div id="refs" class="references">
<div id="ref-coyle2020sl3">
<p>Coyle, Jeremy R, Nima S Hejazi, Ivana Malenica, and Oleg Sofrygin. 2020. <em>sl3: Modern Pipelines for Machine Learning and Super Learning</em>. <a href="https://github.com/tlverse/sl3" class="uri">https://github.com/tlverse/sl3</a>. <a href="https://doi.org/10.5281/zenodo.1342293" class="uri">https://doi.org/10.5281/zenodo.1342293</a>.</p>
</div>
<div id="ref-coyle2019hal9001">
<p>Coyle, Jeremy R, Nima S Hejazi, and Mark J van der Laan. 2019. <em>hal9001: The Scalable Highly Adaptive Lasso</em>. <a href="https://github.com/tlverse/hal9001" class="uri">https://github.com/tlverse/hal9001</a>. <a href="https://doi.org/10.5281/zenodo.3558313" class="uri">https://doi.org/10.5281/zenodo.3558313</a>.</p>
</div>
<div id="ref-diaz2018stochastic">
<p>Díaz, Iván, and Mark J van der Laan. 2018. “Stochastic Treatment Regimes.” In <em>Targeted Learning in Data Science: Causal Inference for Complex Longitudinal Studies</em>, 167–80. Springer Science &amp; Business Media.</p>
</div>
<div id="ref-pearl2000causality">
<p>Pearl, Judea. 2000. <em>Causality</em>. Cambridge university press.</p>
</div>
<div id="ref-rose2011targeted2sd">
<p>Rose, Sherri, and Mark J van der Laan. 2011. “A Targeted Maximum Likelihood Estimator for Two-Stage Designs.” <em>The International Journal of Biostatistics</em> 7 (1): 1–21.</p>
</div>
<div id="ref-vdl2007super">
<p>van der Laan, Mark J, Eric C Polley, and Alan E Hubbard. 2007. “Super Learner.” <em>Statistical Applications in Genetics and Molecular Biology</em> 6 (1).</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#introduction">Introduction</a></li>
      <li><a href="#data-and-notation">Data and Notation</a></li>
      <li><a href="#methodology">Methodology</a></li>
      <li><a href="#advanced-usage-user-specified-regressions"><em>Advanced Usage:</em> User-Specified Regressions</a></li>
      <li><a href="#references">References</a></li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Nima Hejazi, David Benkeser.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
